var addon = require("./pSpace.js");  //引入pSpace模块

var pSpaceName2Conn = new Array();

var interval;
var ps = new addon();

function RegConn(pSpaceName,address,user,password){
  for(i=0;i<pSpaceName2Conn.length;i++){
      if(pSpaceName2Conn[i].key==pSpaceName){
		if(!pSpaceName2Conn[i].value || pSpaceName2Conn[i].value.hasOwnProperty("errString") ||!pSpaceName2Conn[i].value.isConnected()){ 
			var conn1 = ps.open(address,user,password);
			pSpaceName2Conn[i].value = conn1;
			pSpaceName2Conn[i].pSpace.address = address;
			pSpaceName2Conn[i].pSpace.user = user;
			pSpaceName2Conn[i].pSpace.password = password;
		}
        return conn1;
      }
    }
  var conn = ps.open(address,user,password);
  pSpaceName2Conn.push({ key:pSpaceName,
                        value : conn,
						pSpace :{address:address,
								 user:user,
								 password:password
								}});
  return conn;
}
exports.RegConn = RegConn;

exports.GetConn = function(pSpaceName){

    for(i=0;i<pSpaceName2Conn.length;i++){
      if(pSpaceName2Conn[i].key==pSpaceName){    
        return pSpaceName2Conn[i].value;
      }
    }
    return {code:-1,errString:"the data source does not exist."};
}

exports.RemConn= function(pSpaceName){
   for(i=0;i<pSpaceName2Conn.length;i++){
      if(pSpaceName2Conn[i].key==pSpaceName){    
         return pSpaceName2Conn[i].value.close();
      }
    }
    return {code:-1,errString:"the data source does not exist."};
}

//断线重连
exports.ConnectProtection = function(){
	interval = setInterval(function(){
	for(i=0;i<pSpaceName2Conn.length;i++){
      if(!pSpaceName2Conn[i].value || pSpaceName2Conn[i].value.hasOwnProperty("errString") ||!pSpaceName2Conn[i].value.isConnected()){ 
		 console.error(pSpaceName2Conn[i].pSpace.address,pSpaceName2Conn[i].pSpace.user,"连接中断，尝试进行重连...");
		 RegConn(pSpaceName2Conn[i].key,pSpaceName2Conn[i].pSpace.address,pSpaceName2Conn[i].pSpace.user,pSpaceName2Conn[i].pSpace.password);
      }
    }
	},1000);

}

exports.ClearConnectProtection = function(){
	clearInterval(interval);
}